ä»Šå¤©çš„ç›®æ¨™æ˜¯å¼„å‡ºä¸€å€‹å¯ä»¥ç™¼å…‰çš„LEDç‡ˆã€‚

# ä½¿ç”¨RPIé€£æ¥PCA9955B
é¦–å…ˆï¼ŒRPIè…³ä½å¦‚ä¸‹
![[RPIè…³ä½åœ–.png|100]]
æˆ‘å€‘è¦ä½¿ç”¨ 3.3V Power(1)ã€SDA(3)ã€SDL(5)ï¼Œä¸‰å€‹è…³ä½æ¥åˆ°PCA9955B
![[PCA9955Bè…³ä½åœ–.png|100]]

# Code
## æ‰“é–‹ i2c bus
```cpp
#include <cmath>
#include <cstdio>
#include <fcntl.h>
#include <linux/i2c-dev.h>
#include <sys/ioctl.h>
#include <unistd.h>

int main() {
  // åˆå§‹åŒ–è®Šæ•¸
  const char *filename = "/dev/i2c-1"; // I2C ç¸½ç·š
  int fd;

  // æ‰“é–‹ I2C ç¸½ç·š
  if ((fd = open(filename, O_RDWR)) < 0) {
    fprintf(stderr, "Failed to open the i2c bus.\n");
    return -1;
  }
  ```
è¦è¨˜å¾—æ‰“é–‹RPIçš„è¨­å®š
```
sudo raspi-config
```
interface option â†’ I2C enable
### æª¢æŸ¥ï¼Œç”¨`lsmod`
```
lsmod | grep i2c
```
æ‡‰è©²èƒ½çœ‹åˆ°åƒ `i2c_bcm2835` å’Œ `i2c_dev` é€™æ¨£çš„æ¨¡çµ„ã€‚å¦‚æœæ²’æœ‰ï¼Œæ‰‹å‹•åŠ è¼‰æ¨¡çµ„ï¼š
```
sudo modprobe i2c_bcm2835
sudo modprobe i2c_dev
```

Done !

## è¨­å®š PCA_ADDR
```cpp
  const int PCA_ADDR = 0x22;           // PCA9955B çš„ I2C ä½å€
  // è¨­ç½® I2C slave ä½å€
  if (ioctl(fd, I2C_SLAVE, PCA_ADDR) < 0) {
    fprintf(stderr, "Failed to acquire bus access or talk to slave.\n");
    close(fd);
    return -1;
  }
```
### æª¢æŸ¥ç”¨`i2cdetect`
```
i2cdetect -y 1
```
æ‡‰è©²è¦é•·é€™æ¨£
```bash
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:                         -- -- -- -- -- -- -- --
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
20: -- -- 22 -- -- -- -- -- -- -- -- -- -- -- -- --
30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
70: 70 -- -- -- -- -- 76 --
```
ä¸€ç›´é‡åˆ°[[ğŸ”´fail to detect i2c]] ä½†å‘¨å† å®‡æ›äº†ä¸€å€‹RPIå¾Œå¯ä»¥æ¸¬åˆ°äº†ã€‚
## åˆå§‹åŒ– PCA9955B è¨­å®š
```cpp
  // åˆå§‹åŒ– PCA9955B è¨­å®š
  unsigned char config[2] = {0x45, 0xFF}; // å‡è¨­å¯„å­˜å™¨ 0x45 æ˜¯è¦è¨­ç½®çš„ä½å€
  if (write(fd, config, 2) != 2) {
    fprintf(stderr, "Failed to write config to PCA9955B.\n");
    close(fd);
    return -1;
  }
```

## è¨­å®š LED çš„ PWM å€¼
```cpp
  // è¨­å®š LED çš„ PWM å€¼
  unsigned char buffer[4];
  buffer[0] = 0x88; // å‡è¨­å¯„å­˜å™¨ 0x88 æ˜¯ PWM æ§åˆ¶çš„ä½å€
  buffer[1] = 0x80; // ç´…è‰²å€¼ (ç¯„åœ 0-255)
  buffer[2] = 0x80; // ç¶ è‰²å€¼ (ç¯„åœ 0-255)
  buffer[3] = 0x80; // è—è‰²å€¼ (ç¯„åœ 0-255)

  if (write(fd, buffer, 4) != 4) {
    fprintf(stderr, "Failed to write PWM values to PCA9955B.\n");
    close(fd);
    return -1;
  }

  printf("LED is set successfully!\n");

  // é—œé–‰ I2C ç¸½ç·š
  close(fd);
  return 0;
}
```
## LED çš„è…³ä½å•é¡Œ
LEDçš„è…³ä½ç‚ºä¸‰çŸ­ä¸€é•·ï¼Œé•·çš„é‚£å€‹è¦æ¥ä¸Š 5V å› ç‚ºä»–æ˜¯å…±é™½çš„LEDã€‚
ä¸¦ä¸”ä½¿ç”¨é›»æºä¾›æ‡‰å™¨æ¸¬é‡è—è‰²èˆ‡ç¶ è‰²çš„LEDæ²’æœ‰å•é¡Œå¯ä»¥æ­£å¸¸ç™¼å…‰ (é›»æµ0.050mA)

## RPI è¼¸å‡ºè¨Šè™Ÿ
æˆ‘å€‘å°‡SDAå’ŒSCLæ¥ä¸Šé‚è¼¯åˆ†æå„€ï¼Œä¸¦ä¸”ä½¿ç”¨ **shifted** ä¾†decodeï¼Œå¯ä»¥å¾—åˆ°è¨Šè™Ÿç‚º
(åœ–ç‰‡æ”¯æ´)(åæ­£å°±æ˜¯æ­£å¸¸çš„)(ä¸¦ä¸”æ¯æ¬¡åœ¨å‚³è¨Šæ¯æ™‚ï¼Œä»–éƒ½æœƒè‡ªå‹•å‘¼å«`PCA_ADDR`)

> [!NOTE] ç•¶å‚³å‡ºå»çš„æ™‚å€™I2Cå·²ç¶“æœ‰shift

è¦è¨˜å¾—æŠŠOEæ¥åˆ°GNDã€‚(BY ChatGPT)(reference: 7.4)



